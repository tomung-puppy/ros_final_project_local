# ROS Project: Office robot service


# 프로젝트 소개

- 오피스 안에서 여러가지 작업을 수행하는 자율주행을 탑재한 로봇과 로봇관제시스템, 오피스 IoT 시스템을 겸비한 서비스를 제공

## 프로젝트 시나리오

- 구성
    - 관리자 : 관리자 앱을 통해 로봇 관제와 로봇상태, 오피스 상태를 모니터링
    - 내부 직원 : 직원 앱을 통해 로봇에게 작업 명령 또는 오피스에 대한 환경제어 가능
    - 게스트 : 담당 내부직원으로 부터 게스트 전용 QR코드를 받고 출입 인증용으로 사용
- 시나리오
    
    # **스마트 오피스 로봇 서비스 시나리오**
    
    ---
    
    ## **시나리오 1. 간식 심부름 서비스**
    
    ### **개요**
    
    사내 사용자가 간식 요청 시, 서비스 로봇이 간식 창고에서 물품을 수령하여 요청 위치까지 전달하는 시나리오
    
    ### **흐름**
    
    1. 시스템은 가동 가능한 로봇을 확인한다.
    2. 사용자는 앱 또는 자연어 기반 인터페이스를 통해 간식 주문을 요청한다.
    3. 로봇은 요청을 수신하고 간식 창고로 이동한다.
    4. 로봇은 마커 또는 객체 인식을 통해 요청된 간식을 식별한다.
    5. 사용자 확인 인터페이스를 통해 간식 탑재를 완료한다.
    6. 로봇은 요청한 사용자 좌석 또는 지정된 위치로 이동한다.
    7. 전달 완료 여부를 확인한다.
    8. 작업 종료 후 로봇은 로비(대기 위치)로 복귀한다.
    
    ---
    
    ## **시나리오 2. 사내 배달 서비스**
    
    ### **개요**
    
    사용자 간 또는 지정 위치 간 물품 전달을 수행하는 로봇 배달 시나리오
    
    ### **흐름**
    
    1. 사용자가 로봇 호출 또는 배달 요청을 수행한다.
    2. 시스템은 가동 가능한 로봇을 선택한다.
    3. 로봇은 요청자의 위치로 이동한다.
    4. 로봇은 전달할 물품을 수령한다.
    5. 사용자는 배송 대상 사용자 또는 위치를 지정한다.
    6. 로봇은 대상 위치로 이동한다.
    7. 물품 전달 완료를 확인한다.
    8. 로봇은 로비로 복귀한다.
    
    ---
    
    ## **시나리오 3. 외부인 가이드 서비스**
    
    ### **개요**
    
    방문객을 식별하고 예약된 목적지까지 안내하는 로비 기반 가이드 시나리오
    
    ### **흐름**
    
    1. 로봇은 로비에서 얼굴 인식을 수행한다.
    2. 인식 결과에 따라 내부인과 외부인을 구분한다.
        - 내부인: 이동 동선 방해 없이 길을 비켜준다.
    3. 외부인으로 판별될 경우 방문 로그를 저장한다.
    4. 외부인은 QR 코드 스캔 등 인증 절차를 수행한다.
    5. 시스템은 예약 정보를 확인한다.
    6. 로봇은 예약된 목적지까지 이동하며 방문객을 가이드한다.
    7. 목적지 도착 후 가이드 완료를 알린다.
    8. 로봇은 로비로 복귀한다.
    
    ---
    
    ## **시나리오 4. 회의실 및 오피스 관리 서비스**
    
    ### **개요**
    
    회의실 및 오피스 공간의 사용 현황 확인과 서비스 제공을 위한 시나리오
    
    ### **흐름**
    
    1. 사용자는 앱을 통해 회의실 예약 또는 예약 취소를 요청한다.
    2. 시스템은 회의실 및 오피스 좌석 현황을 제공한다.
    3. 사용자는 회의실 관련 서비스(물품 배달 등)를 요청한다.
    4. 로봇은 요청된 회의실로 이동하여 물품을 전달한다.
    5. 사용자는 회의실 환경 제어 요청을 수행한다.
    6. 시스템은 원격으로 회의실 환경을 설정한다.
    7. 작업 완료 후 로봇은 로비로 복귀한다.
    
    ---
    
    ## **시나리오 공통 사항**
    
    - 모든 시나리오는 가동 가능한 로봇 상태를 기준으로 수행된다.
    - 작업 실패 또는 예외 상황 발생 시 사용자에게 알림을 제공한다.
    - 각 시나리오 종료 후 로봇은 기본 대기 위치(로비)로 이동한다.
    - 모든 작업 이력은 로그 데이터로 저장된다.

# System Requirement

| SR_ID | SR_NAME | Description | Priority |
| --- | --- | --- | --- |
| **SR-001** | **자율주행 및 경로 생성** | 로봇은 맵 기반 위치 추정(Localization)과 전역 경로 생성(Global Planning)을 통해 사용자가 요청한 목적지까지 정숙하게 이동해야 한다. | **P** |
| **SR-002** | **장애물 인식 기능** | 로봇은 카메라/라이다를 통해서 장애물을 감지해야 한다. 
장애물 종류 
• 정적 (박스, 의자)
• 동적 (로봇, 사람) | **P** |
| **SR-003** | 장애물 회피 기능 (정적) | 로봇은 정적인 장애물 발견시 우회해야 한다.
고려사항
• 도로 폭 | **P** |
| **SR-004** | 장애물 회피 기능 (동적) | **로봇은** 동적인 장애물 발견시 회피해야 한다.
고려사항
• 도로 폭
• 동적 장애물 속도
• 동적 장애물 거리
• 동적 장애물 종류 | **P** |
| **SR-005** | **방문객 확인 기능** | 대기 모드인 로봇은 카메라를 통해 방문객을 확인해야 한다.
즉시 가이드 모드로 전환해야 한다.
• 방문객은 대기상태의 로봇에게 방문객 인증을 받아야한다.
• 인증된 방문객이 아닐 시 알람을 울린다. | **P** |
| **SR-006** | **간식 인식 기능** | 로봇은 카메라로 간식을 인식하여, 사용자가 요청한 물품이 맞는지 식별해야한다
• 인식 방법
    ◦ 객체형상 인식 | **P** |
| **SR-007** | **내부직원 앱 알람 기능** | 로봇이 작업 완료(도착) 시, **내부 직원의 앱으로 알림**을 전송해야 한다.
알람 정보
• 이벤트 종류
• 이벤트 발생 시간
• 발생한 로봇 정보
• 발생 위치
• 요청 사람
이벤트
• 외부인 인증 완료시 → 담당 내부 직원
• 인증된 외부인 가이드 완료시 → 담당 내부 직원
• 인증되지 않은 외부인 출입시 → 모든 내부 직원
• 로봇 배정 완료 시 → 사용자
• 간식 배송 완료시 → 사용자
• 물품 배송 완료시 → 배송 수신 사용자
• 물품 배송 픽업시 → 배송 요청 사용자
• 간식 재고 없을 시 → 사용자
 | **P** |
| **SR-008** | **로봇 디스플레이 기능** | 로봇 본체 화면에 현재 상태(배달 중, 안내 중)와 방문객용 지시사항("Follow Me")을 **텍스트와 아이콘으로 시각화**해야 한다.
• 로봇 상태
    ◦ 배달
    ◦ 안내
    ◦ 대기
• 방문객용 지시사항
    ◦ 외부인 감지시
        ▪ “QR 코드를 인증해주세요” 표시
    ◦ 외부인 가이드시
        ▪ “Follow me” 와 “안내중”을 번갈아가며 보여줌
        ▪ 도착시 “도착완료” 표시 | **P** |
| **SR-009** | **로봇 제어 기능 (User)** | **내부 직원**은 앱을 통해 로봇 호출, 주문뿐만 아니라 **'수령 확인', '복귀 명령' 등 로봇 제어 기능**을 수행해야 한다.
제어 항목 
• 로봇 호출/호출 취소
• 복귀 명령
• 간식 배달
• 물품 배달
• 수령 확인 → 복귀 | **P** |
| **SR-011** | **멀티 로봇 관제 대시보드** | 관리자는 웹 기반 지도상에서 로봇 2대의 상태를 한눈에 모니터링할 수 있어야 한다.
• 실시간 위치
• 배터리
• 작업 상태 | **P** |
| **SR-012** | **스마트 배차 기능** | 시스템은 사용자에게 최적의 로봇을 배차해야한다.
최적 고려 사항
• 로봇의 거리
• 로봇의 상태
• 경로 거리
또한 동시에 들어온 요청을 처리 할 수 있어야한다.
시스템은 모든 로봇이 작업중일 경우에 들어온 요청에 대하여 순차 배차관리를 할 수 있어야 한다. | **P** |
| **SR-013** | **교착 상태 제어 (Traffic)** | 좁은 길에서 로봇 간 충돌이나 경로 겹침 발생 시, 우선순위를 조정하여 교착 상태를 해결해야 한다.
고려사항
• 사람의 유무
• Task 우선순위
    ◦ 1. 가이드, 2. 물품 배송, 3. 간식 배송
• 로봇들의 목표지점과 남은거리 | **P** |
| **SR-014** | **복구 기능** | 시스템이 **오류(경로 막힘)를 감지하여 재시도/복귀하는 자동 복구 로직**을 수행해야 한다. | **P** |
| **SR-015** | **맵 설정 기능** | 관리자는 GUI에서 금지 구역(시설물)을 설정할 수 있어야 하고, **주요 목적지(회의실, 창고 등) 데이터를 관리**하여 로봇에게 전달해야 한다.
금지구역 정의
• 리모델링 중인 구역
• 시설물 점검 중인 구역
시설물 종류
• 사무실
• 회의실
• 비품 창고
• 충전소 | **O** |
| **SR-017** | **사무실 환경 제어 기능** | 시스템은 오피스의 개별 시설물 내 조명/온습도 조절 장치와 통신하여 사용자 앱 요청에 따른 환경 제어를 수행해야 한다. | **O** |
| **SR-018** | **자동 충전 기능** | 로봇은 임무 완료 시 또는 배터리 10% 이하시 자동으로 충전 스테이션으로 복귀해야 한다.
• 배터리가 10% 이하시 사용자의 요청을 무시한다. | **P** |
| **SR-019** | **로그 기능** | 시스템은 각종 로그를 DB에 저장하고 통계 조회 기능을 제공해야 한다.
• 로그할 정보
    ◦ 작업 및 미션 로그
    ◦ 로봇 상태 및 주행 로그
    ◦ 시스템 에러 및 이벤트 로그 | **O** |
| **SR-020** | 로그 조회 기능 | 시스템은 DB에 저장된 로그를 조회할 수  있어야 한다.
• 검색 조건 명시
    ◦ 발생 기간
    ◦ 이벤트 종류
    ◦ 대상 로봇
• 결과물 항목 정의
    ◦ 발생 일시
    ◦ 이벤트 타입
    ◦ 대상 로봇 | **O** |
| **SR-021** | **방문객 안내 기능** | 로봇은 인증된 방문객 안내 시 **센서/카메라로 사람과의 거리를 유지**하며 주행하고, 목적지 도착 후 **일정 시간 대기 뒤 자동 복귀**해야 한다.
• 로봇은 인증된 방문객을 예약된 회의실로 리딩하여 가이드 해야한다.
• 가이드 시 방문객과의 거리를 `1m<d<2m` 로 일정하게 유지해야한다.
    ◦ 목표 지점에서는 유지할 필요는 없음
• 가이드 시 방문객이 사라지면 다시 인식될때까지 기다린다. 
• 가이드 시 방문객이 움직이지 않을 시 잠시 멈춘다.
• 목적지 도착후 3초 대기 후 대기장소(충전스테이션)로 자동복귀한다. | **P** |

# System Architecture

## HW + Service (초안)

- 로봇들
    - 라즈베리파이 5
        - Micro ROS
    - 바퀴 2개(다이나믹 셀 모터 2개)
    - 전방 카메라
    - 라이다 센서
    - LCD
    - LED
    - 초음파 센서
- WiFI 공유기
- 로봇 관제 서버
    - 로봇 관제 서비스
        - 배차, 경로 planning, Mapping
    - 로봇 제어 서비스
        - 사용자 요청에 대한 제어 (심부름, 호출, 배달 등)
    - DB (lMySQL), local
        - 시스템 로그 DB
        - 이벤트 로그 DB
        - 데이터 로그 DB
- 사무실 제어 서버
    - 회의실 예약 관리 서비스
    - 회의실 및 사무실 환경제어 서비스
- AI 추론 서버
    - 객체 인식 서비스
        - 간식, 회의실 비품 식별
        - 내부직원, 외부인(게스트) 판별
        - 게스트 가이드(리딩) 트랙킹
- 실내 환경 센서들
    - 회의실 1 온습도 센서
    - 회의실 2 온습도 센서
    - 사무실 온습도 센서
- 관리자 PC
    - 관리자 앱
        - 로봇 상태 모니터링
            - 위치, 배터리, 목표지점(경로), 상태
        - 실내 환경 모니터링 및 제어
- 내부 직원 핸드폰
    - 직원 앱
        - 로봇 호출
        - 로봇 작업 명령
            - 간식 심부름, 오피스내 배달,
- 게스트 폰
    - 게스트 QR코드
        - 출입 인증

## 개선된 SA

---

### 1. 개선된 시스템 아키텍처 (Revised System Architecture)

시스템을 크게 **로봇 엣지(Robot Edge)**, **서비스 코어(Server Core)**, **사용자 인터페이스(Client)**, **인프라(Infrastructure)** 계층으로 나누어 구조화했습니다.

### **A. Robot Edge Layer (로봇 단말)**

*라즈베리파이 5 기반의 ROS 2 환경에서 구동되며, 실시간 주행과 센싱을 담당합니다.*

- **Main Controller (Raspberry Pi 5)**: Ubuntu / ROS 2 (Humble 또는 Jazzy) 기반
    - **Navigation Node**: SLAM(Cartographer/Slam_toolbox) 및 Navigation2 스택 구동.
    - **Perception Node**: LiDAR 및 카메라 데이터를 퓨전하여 정적/동적 장애물 인식.
    - **Vision Client Node**: 카메라 영상을 AI 서버로 스트리밍하거나 경량 모델(TFLite)로 1차 객체(마커, 사람) 검출.
    - **Interface Node**: LCD 디스플레이(상태 표시, QR 유도) 및 LED/Speaker 제어.
    - **Comm. Bridge**: 서버와 통신(MQTT/WebSocket)을 담당하는 ROS Bridge.
- **Low-level Control (Micro-ROS / MCU)**:
    - 모터 드라이버 제어 (속도/위치 제어), IMU 센서 데이터 획득, 배터리 전압 모니터링.

### **B. Server Core Layer (백엔드 및 관제)**

*로봇들의 두뇌 역할을 하며, 업무 할당과 트래픽을 관리합니다.*

- **Fleet Management System (FMS)**:
    - **Dispatcher (배차 관리)**: 로봇 위치, 배터리, 작업 우선순위를 고려하여 최적 로봇 할당.
    - **Traffic Controller**: 다중 로봇 간 경로 겹침 및 교착 상태(Deadlock) 해결 로직 수행.
    - **Map Manager**: 전역 지도 관리, 금지 구역(가상 벽) 및 POI(Point of Interest) 동기화.
- **Task Management Service**:
    - 사용자 요청(간식, 배달, 가이드)을 로봇이 이해할 수 있는 일련의 Action Sequence로 변환.
- **AI Inference Server (GPU Server)**:
    - **Face Recognition**: 방문객/직원 얼굴 인식 및 판별.
    - **Object Detection**: 간식 종류 식별 및 비품 인식 정밀 분석.
- **Office IoT Server**:
    - 사무실 내 온습도 센서 수집 및 조명/에어컨 제어 명령 처리.
- **Database (MySQL/NoSQL)**:
    - 운행 로그, 에러 로그, 사용자 정보, 맵 데이터 저장.

### **C. User Interface Layer (사용자 접점)**

- **Admin Web (Dashboard)**: 전체 로봇 위치 실시간 관제(Map View), 상태 모니터링, 로그 조회.
- **Employee App**: 로봇 호출, 배달 명령, 문 열기/조명 제어, 알림 수신(Push Notification).
- **Guest Interface**: QR 코드 출입 인증, 로봇 안내 팔로우.

---

### 2. 데이터 흐름 분석 (Data Flow)

주요 시나리오별로 데이터가 어떻게 흐르는지 정리한 표입니다.

### **Table 1. 주요 서비스 시나리오 데이터 흐름**

| **시나리오 / 기능** | **단계** | **송신 (Source)** | **수신 (Destination)** | **데이터 내용 (Content)** | **관련 SR** |
| --- | --- | --- | --- | --- | --- |
| **간식 심부름** | 1. 주문 요청 | 직원 앱 | Task Server | 주문 품목, 요청자 위치(좌석ID) | SR-009 |
|  | 2. 로봇 배차 | FMS (Dispatcher) | Robot (Selected) | **Action Command**: `GoTo(Pantry) -> Pickup -> GoTo(User)` | SR-012 |
|  | 3. 간식 인식 | Robot (Camera) | AI Server | 간식 이미지 스트림 또는 캡처 | SR-006 |
|  | 4. 인식 결과 | AI Server | Robot / Task Server | `Object: Snackle_A, Confidence: 98%` | SR-006 |
|  | 5. 도착 알림 | Task Server | 직원 앱 (FCM) | "로봇이 좌석에 도착했습니다." | SR-007 |
| **방문객 가이드** | 1. 얼굴 감지 | Robot (Camera) | AI Server | 얼굴 이미지 | SR-005 |
|  | 2. 방문객 판별 | AI Server | Task Server | `Type: Guest / Employee, ID: Null` | Scenario 3 |
|  | 3. 안내 모드 전환 | Task Server | Robot | **State Change**: `Idle` -> `Guide_Ready`, **Display**: "QR Code" | SR-008 |
|  | 4. 가이드 주행 | Robot (Lidar/Cam) | Robot (Local Planner) | 사람과의 거리 유지 (`1m < d < 2m`) 및 속도 조절 | SR-021 |
| **관제 및 트래픽** | 1. 상태 보고 | Robot | FMS | 위치(x,y,theta), 배터리(%), 상태(Busy/Idle) | SR-011 |
|  | 2. 충돌 감지 | Robot A / B | FMS (Traffic) | 경로 중첩 감지 | SR-013 |
|  | 3. 우선순위 제어 | FMS (Traffic) | Robot B | `Pause` 또는 `Re-path(Wait_point)` 명령 | SR-013 |
| **사무실 제어** | 1. 환경 제어 요청 | 직원 앱 | Office IoT Server | "회의실 A 온도 24도 설정" | SR-017 |
|  | 2. 기기 제어 | Office IoT Server | IoT Device (AC) | IR/RS485 신호 전송 | SR-017 |

---

### 3. 기술적 보완 권장사항 (Recommendation)

제안서의 완성도를 높이기 위해 다음의 기술적 요소들을 구체화하는 것이 좋습니다.

1. **통신 미들웨어 명시**:
    - **Robot ↔ Server**: ROS 2는 로컬 네트워크(LAN)에서는 좋지만, Wi-Fi 환경의 서버 통신에는 불안정할 수 있습니다. **ROSbridge (WebSocket)** 또는 **Zenoh**, **MQTT**를 사용하여 로봇과 관제 서버 간의 통신을 래핑(Wrapping)하는 구조를 추천합니다.
    - 예: `Robot (ROS2) <-> [ROS-MQTT Bridge] <-> Broker <-> FMS Server`
2. **AI 처리 위치의 분리**:
    - *장애물 회피(SR-004)**와 같은 즉각적인 반응이 필요한 AI(객체 인식)는 네트워크 지연을 방지하기 위해 **로봇 엣지(RP5)**에서 처리해야 합니다.
    - 반면, **얼굴 인식(SR-005)**이나 정밀한 **비품 재고 파악**은 리소스를 많이 차지하므로 **AI 추론 서버**로 이미지를 보내 처리하는 하이브리드 방식이 적합합니다.
3. **오차 보정 (Relocalization)**:
    - 오피스 환경은 사람의 이동으로 환경이 자주 바뀝니다. SR-001(위치 추정)을 위해 LiDAR 기반의 SLAM 외에도, 천장 마커나 특정 지점(충전소)에서의 **위치 초기화 로직**을 아키텍처에 포함하면 신뢰도가 높아집니다.

---

**다음 단계로 무엇을 도와드릴까요?**

이 아키텍처를 바탕으로 **"API 명세서(로봇 제어 프로토콜)"** 초안을 작성하거나, **"하드웨어 부품 선정 리스트(BOM)"**를 구체화해 드릴 수 있습니다.

## 통신구조

제안해주신 시스템 아키텍처를 기반으로, **안정성(Reliability)**과 **실시간성(Real-time)**을 모두 고려한 통신 구조를 설계했습니다.

로봇 내부의 빠른 데이터 교환은 **ROS 2**, 서버와의 신뢰성 있는 명령 전달은 **TCP**, 그리고 대용량 영상 데이터의 지연 없는 전송은 **UDP**를 사용하는 하이브리드 통신 구조입니다.

---

### **통신 구조 개요 (Communication Topology)**

### **1. 로봇 내부 통신 (Robot Internal Layer)**

**통신 방식: ROS 2 (DDS/Shared Memory)**

라즈베리파이 5 내부에서 노드(Node) 간 데이터 교환은 ROS 2 미들웨어를 사용합니다.

| **통신 구간 (From ↔ To)** | **통신 방식** | **데이터 예시** | **선정 이유** |
| --- | --- | --- | --- |
| **Sensors** $\leftrightarrow$ **SLAM/Nav** | **ROS 2 Topic** (Pub/Sub) | • LiDAR Scan Data (`Sensor_msgs/LaserScan`)
• Camera Image (`Sensor_msgs/Image`)
• IMU Data | 센서 데이터는 지속적으로 발생하며, 최신 데이터가 중요하므로 **Best Effort QoS** 기반의 Pub/Sub 패턴이 적합합니다. |
| **Nav2** $\leftrightarrow$ **Motor Control** | **ROS 2 Topic** | • 속도 명령 (`cmd_vel`)
• 오도메트리 (`odom`) | 실시간 제어를 위해 지연 시간이 최소화된 ROS 2 내부 통신이 필수적입니다. |
| **Task Mgr** $\leftrightarrow$ **Nav2** | **ROS 2 Action** | • 목표 지점 이동 (`MapsToPose`) | "목표지점 이동"은 시간이 오래 걸리며, 중간 피드백(진행률)과 취소 기능이 필요하므로 **Action**이 적합합니다. |
| **App Interface** $\leftrightarrow$ **Control** | **ROS 2 Service** | • 파라미터 변경 (속도 제한 설정)
• 초기 위치 설정 | 요청에 대한 즉각적인 성공/실패 응답(Sync)이 필요하므로 **Service**를 사용합니다. |

---

### **2. 로봇 $\leftrightarrow$ 서버 통신 (Robot-Server Layer)**

**통신 방식: TCP (Command & Control) & UDP (Streaming)**

로봇과 서버 간의 통신은 Wi-Fi 무선 환경을 고려하여 목적에 따라 프로토콜을 분리합니다.

### **A. 관제 및 제어 (Control Plane)**

- **Protocol**: **TCP/IP** (WebSocket 또는 MQTT over TCP)
- **관련 SR**: SR-011(관제), SR-012(배차), SR-013(트래픽), SR-019(로그)

| **송신 (Sender)** | **수신 (Receiver)** | **데이터 내용** | **특징** |
| --- | --- | --- | --- |
| **Robot (Bridge)** | **FMS Server** | • 로봇 상태 (위치 좌표 x,y, 배터리 %, 상태 코드)
• 작업 완료/실패 리포트 | **신뢰성 필수**. 패킷 손실 시 로봇의 위치가 튀거나 배차 명령이 누락되면 안 되므로 **TCP**로 재전송을 보장해야 합니다. |
| **FMS Server** | **Robot (Bridge)** | • 작업 할당 (`GoTo: MeetingRoom1`)
• 긴급 정지/복귀 명령 | 서버의 명령은 반드시 로봇에게 도달해야 합니다(Guaranteed Delivery). |

### **B. 영상 및 AI 추론 (Data Plane)**

- **Protocol**: **UDP** (RTP/RTSP or WebRTC)
- **관련 SR**: SR-005(방문객 확인), SR-006(간식 인식), SR-021(가이드)

| **송신 (Sender)** | **수신 (Receiver)** | **데이터 내용** | **특징** |
| --- | --- | --- | --- |
| **Robot (Cam)** | **AI Inference Server** | • 카메라 Live Stream (H.264/MJPEG)
• 전방 영상 원본 | **실시간성 중요**. 영상 프레임이 1~2개 유실되더라도 지연(Latency) 없이 전송되어야 AI가 빠르게 판단할 수 있습니다. **UDP**가 적합합니다. |
| **AI Server** | **Robot / Task Server** | • 추론 결과 (좌표, 객체 Class, ID) | 추론 결과 데이터 자체는 크기가 작고 중요하므로 이 부분은 **TCP**로 응답을 줍니다. |

---

### **3. 서버 $\leftrightarrow$ 사용자/인프라 통신 (Service Layer)**

**통신 방식: TCP (HTTP/HTTPS, WebSocket)**

사용자 앱과 IoT 장비는 표준 웹 프로토콜을 사용합니다.

| **통신 구간** | **통신 방식** | **데이터 내용** | **선정 이유** |
| --- | --- | --- | --- |
| **User App** $\leftrightarrow$ **API Server** | **TCP** (HTTP REST) | • 로봇 호출 요청
• 회원 가입/로그인
• 회의실 예약 | 트랜잭션의 정확성이 중요하며, 요청-응답(Request-Response) 모델인 **REST API**가 표준입니다. |
| **Admin Web** $\leftrightarrow$ **FMS Server** | **TCP** (WebSocket) | • 실시간 맵 모니터링
• 로봇 이동 궤적 시각화 | 웹 브라우저에서 지속적으로 갱신되는 로봇 위치를 보기 위해 양방향 연결인 **WebSocket**이 필요합니다. |
| **IoT Server** $\leftrightarrow$ **Smart Office** | **TCP** (Modbus TCP / API) | • 조명 On/Off 제어
• 온습도 센서 값 조회 | 하드웨어 제어 신호는 정확하게 전달되어야 하므로 **TCP** 기반 통신을 사용합니다. |

---

### **4. 데이터 흐름도 및 프로토콜 매핑 요약**

아래 표는 각 데이터 흐름 단계에서 어떤 프로토콜이 사용되는지 한눈에 보여줍니다.

| **Data Flow Step** | **Source Node** | **Target Node** | **Protocol** | **Why?** |
| --- | --- | --- | --- | --- |
| **1. 센싱 (Sensing)** | LiDAR/Camera | Main Controller | **ROS 2** | 내부 프로세스 간 고속 데이터 공유 |
| **2. 영상 전송 (Stream)** | Robot Main | AI Server | **UDP** | 끊김보다는 실시간 전송 우선 (Latency 최소화) |
| **3. 상태 보고 (Telemetry)** | Robot Main | FMS Server | **TCP** | 위치/배터리 정보의 무결성 보장 |
| **4. 명령 하달 (Command)** | FMS Server | Robot Main | **TCP** | 작업 명령(Mission)의 확실한 도달 보장 |
| **5. 사용자 알림 (Notify)** | Task Server | User App | **TCP** (Push) | FCM(Firebase) 등 신뢰성 있는 알림 서비스 연동 |

### **5. 개발 시 고려사항 (Tip)**

1. **ROS 2 Bridge 구현**: 로봇(ROS 2)과 서버(TCP) 사이에는 `rosbridge_suite`나 `mqtt_bridge`를 사용하여 ROS 토픽을 JSON 형태의 TCP 패킷으로 변환해주는 과정이 필요합니다.
2. **QoS 설정**: ROS 2 통신 시, LiDAR 데이터는 `volatile`(Best Effort)로 설정하여 네트워크 부하를 줄이고, 제어 명령은 `reliable`로 설정하여 안정성을 확보해야 합니다.
3. **UDP 포트 관리**: 사내 보안망에서 UDP 포트가 막혀있을 수 있으므로, 영상 전송용 포트(예: 5000~5005)에 대한 방화벽 설정을 미리 확인해야 합니다.