# Office Robot Service - 통신 아키텍처 (v1.0)

이 문서는 Office Robot Service 시스템을 구성하는 각 컴포넌트(메인 서버, AI 서버, 로봇, 사용자 앱) 간의 통신 방식, 프로토콜, 그리고 데이터 흐름을 상세히 기술합니다.

---

## 1. 통신 구조 개요

본 시스템의 통신은 목적에 따라 **제어(Control)**, **데이터(Data)**, **추론(Inference)**, **서비스(Service)**의 4개 영역으로 명확히 분리됩니다. 이는 각 통신 링크의 요구사항(신뢰성, 실시간성, 범용성)에 최적화된 기술을 적용하기 위함입니다.

```
+-----------------+      +------------------+      +--------------------+
|   User Apps     |      |                  |      |   AI Server        |
| (Admin/Employee)|<====>|   Main Server    |<====>| (GPU, FastAPI)     |
| [Service Plane] |      | (FastAPI, FMS)   |      | [Inference Plane]  |
+-----------------+      |                  |      +---------^----------+
                         +--------+---------+                |
                                  |                          | [Data Plane]
        [Control Plane]           |                          | (UDP Video Stream)
                                  |                          |
                         +--------v---------+                |
                         |                  |----------------+
                         |   Robot (ROS 2)  |
                         | (Jazzy)          |
                         +------------------+
```

---

## 2. 영역별 상세 명세

### A. 제어 영역 (Control Plane): 메인 서버 <-> 로봇

-   **목적**: 로봇의 동작을 제어하고 상태를 모니터링하는, 신뢰성이 가장 중요한 통신.
-   **방식**: **ROS 브리지 (WebSocket over TCP)**
-   **선정 이유**:
    -   **신뢰성**: TCP 기반으로 메시지 유실을 방지합니다.
    -   **표준화**: `Action Command`, `Robot Status` 등 모든 메시지가 `DEVELOPMENT_GUIDE.md`에 정의된 표준 JSON 형식을 따릅니다.
    -   **개발 효율**: 로봇의 ROS 2 시스템과 서버의 웹 기술 스택을 자연스럽게 연결합니다.
-   **데이터 흐름**:
    -   `서버 -> 로봇`: 작업 할당, 긴급 정지 등 `Action Command Sequence` (JSON) 전송.
    -   `로봇 -> 서버`: 위치, 배터리, 현재 상태 등 `Robot Status` (JSON)를 주기적으로 보고.

### B. 데이터 영역 (Data Plane): 로봇 -> AI 서버

-   **목적**: AI 추론에 사용될 로봇의 카메라 영상을 최소 지연으로 실시간 전송.
-   **방식**: **Raw UDP**
-   **선정 이유**:
    -   **실시간성**: TCP의 핸드셰이크나 재전송 과정이 없어 지연 시간이 가장 짧습니다. 영상 스트리밍에서는 약간의 프레임 유실보다 실시간 전송이 더 중요합니다.
-   **데이터 흐름**:
    -   로봇의 카메라 노드가 촬영한 영상 프레임을 H.264 또는 MJPEG 형식으로 인코딩합니다.
    -   인코딩된 영상 데이터를 AI 서버의 지정된 IP와 Port(예: 54321)로 직접 스트리밍합니다.

### C. 추론 영역 (Inference Plane): 메인 서버 <-> AI 서버

-   **목적**: 메인 서버가 AI 서버의 고성능 컴퓨팅 자원을 활용하여 추론 결과를 얻기 위함.
-   **방식**: **REST API (HTTP/TCP)**
-   **선정 이유**:
    -   **표준화 및 확장성**: 가장 널리 사용되는 서버 간 통신 방식으로, 향후 AI 기능이 추가되더라도 엔드포인트를 확장하기 용이합니다.
-   **데이터 흐름**:
    -   메인 서버가 AI 서버의 `/api/v1/inference/object_detection`과 같은 엔드포인트에 추론할 데이터를 담아 POST 요청을 보냅니다.
    -   AI 서버는 추론 결과를 JSON 형식으로 응답합니다.

### D. 서비스 영역 (Service Plane): 사용자 앱 <-> 메인 서버

-   **목적**: 관리자와 내부 직원이 웹 브라우저를 통해 시스템과 상호작용하며, 특히 관리자는 실시간으로 로봇 상태를 모니터링합니다.
-   **방식**: **웹 (HTTP/HTTPS) + REST API + WebSocket**
-   **선정 이유**:
    -   **범용성**: 모든 최신 웹 브라우저에서 별도의 설치 없이 접근 가능합니다.
    -   **실시간성**: 관리자 앱의 로봇 상태 모니터링과 같은 기능은 WebSocket을 통해 서버 푸시 방식으로 제공되어, 최신 정보를 즉시 반영합니다.
-   **데이터 흐름**:
    -   사용자는 브라우저를 통해 메인 서버가 제공하는 HTML/CSS/JS 파일을 받아 UI를 렌더링합니다.
    -   UI 내의 JavaScript는 초기 데이터를 REST API로 가져오고, 실시간 업데이트가 필요한 경우 WebSocket을 통해 서버로부터 로봇/작업 상태 등 최신 데이터를 받아와 화면을 동적으로 갱신합니다.

---

## 3. 통신 방식 요약 테이블

| **구간 (From <-> To)**   | **프로토콜**                            | **주요 데이터**                             | **선정 이유**                                     |
| ------------------------ | --------------------------------------- | ------------------------------------------- | ------------------------------------------------- |
| 로봇 내부 노드 간        | ROS 2 (DDS)                             | 센서 데이터, 로컬 제어 명령                 | 실시간, 고성능 내부 통신                          |
| 메인 서버 <-> 로봇       | ROS 브리지 (WebSocket/TCP)              | 작업 명령, 로봇 상태 (JSON)                 | 신뢰성 보장, 표준화, 개발 용이성                  |
| 로봇 -> AI 서버          | Raw UDP                                 | H.264/MJPEG 영상 스트림                     | 지연 시간 최소화, 실시간 성 확보                  |
| 메인 서버 <-> AI 서버    | REST API (HTTP/TCP)                     | 추론 요청/결과 (JSON)                       | 표준적이고 확장 가능한 서버 간 통신               |
| 사용자 앱 <-> 메인 서버  | 웹 (HTTP/HTTPS) + REST API + WebSocket  | UI, API 요청/응답 (HTML, JSON), 실시간 상태 | 웹 표준 기술 사용, 범용성 및 실시간성             |
